//Dev Pipeline Deploy to dev environment

pipeline {
    agent any
    environment {
        REPO_URL = 'https://github.com/Thanhlam43k4/Microservices_Nodejs.git'
        FE_IMAGE_ID = 'thanhlam2k4/microservice-fe'
        CUSTOMER_IMAGE_ID = 'thanhlam2k4/microservice-customer'
        SHOPPING_IMAGE_ID = 'thanhlam2k4/microservice-shopping'
        PRODUCT_IMAGE_ID = 'thanhlam2k4/microservice-product'
        DOCKER_NETWORK_NAME = 'micro-dev-net'
        MYSQL_SERVICE_DEV = 'mysql_server'
        JENKINS_DOCKERHUB_CREDENTIALS = 'dockerhub_id'

        DEV_IP_ADDRESS = '192.168.56.105'
    }
    stages {
        stage('Pulling source code') {
            steps {
                echo 'Pulling code from GitHub............'

                git branch: 'main', url: REPO_URL

                echo 'Pulling successfully................'
            }
        }
        stage('Build Docker image and push to DockerHub') {
            steps {
                echo 'Build docker Image in file Dockerfile' //File Dockerfile in the dir of source code
                //Docker command
                echo 'Build Docker Image'

                sh 'docker build -t ${FE_IMAGE_ID} ./frontend'

                sh 'docker build -t ${CUSTOMER_IMAGE_ID} ./customer'
                // //You can run docker image anh check your images in your local machine

                sh 'docker build -t ${SHOPPING_IMAGE_ID} ./shopping'

                sh 'docker build -t ${PRODUCT_IMAGE_ID} ./product'

                sh 'docker images'
                withDockerRegistry(credentialsId: '${JENKINS_DOCKERHUB_CREDENTIALS}', url: 'https://index.docker.io/v1/') {

                    echo 'Push to Dockerhub Registry'
                    
                    sh 'docker push ${CUSTOMER_IMAGE_ID}'

                    sh 'docker push ${SHOPPING_IMAGE_ID}'

                    sh 'docker push ${PRODUCT_IMAGE_ID}'

                    sh 'docker push ${FE_IMAGE_ID}'
                    
                }
            }
        }
        stage('Prune docker data') {
            steps {
                echo 'Prune data in docker!!!'

                sh 'docker system prune -a --volumes -f'
            }
        }
        stage('Deploy to dev environment') {
            steps {
                echo 'Deploy to dev environment.....'
                // sh 'fuser -k 80/tcp'
                // sh 'docker stop $(docker ps -a)'
                // sh 'kill -9 $(lsof -i tcp:80)'

                sh 'docker network create ${DOCKER_NETWORK_NAME} || echo "this network exist"'

                sh 'docker compose up ${MYSQL_SERVICE_DEV} -d'

                sh 'docker compose up -d'

                sh 'docker ps'
            }
        }
        stage('Testing Dev development') {
            steps {
                //Test Product service
                sh 'sleep 10'

                echo 'Testing dev development...'

                sh 'curl ${DEV_IP_ADDRESS}:3000'

                // sh 'docker compose down'
            //
            }
        }
        stage('Deploy to Staging'){
            steps{
                   echo 'Deploy to Staging Environment'
            }
        }
        // post {
        //     // Clean after build
        //     always {
        //         cleanWs()
        //     }
        // }
    }
}
